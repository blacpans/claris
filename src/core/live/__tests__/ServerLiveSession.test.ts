import type { GoogleGenAI } from '@google/genai';
import { beforeEach, describe, expect, it, type Mock, vi } from 'vitest';
import { MemoryService } from '@/core/memory/MemoryService.js';
import { FirestoreSessionService } from '@/sessions/firestoreSession.js';
import { ServerLiveSession } from '../ServerLiveSession.js';

// Mock dependencies
const mockLiveConnect = vi.fn().mockResolvedValue({
  sendRealtimeInput: vi.fn(),
});

vi.mock('@google/genai', () => {
  return {
    GoogleGenAI: class {
      live = {
        connect: mockLiveConnect,
      };
    },
  };
});

vi.mock('@/sessions/firestoreSession.js', () => ({
  FirestoreSessionService: class {
    getSession = vi.fn();
    getLatestSession = vi.fn();
    appendEvents = vi.fn();
  },
}));

vi.mock('@/core/memory/MemoryService.js', () => ({
  MemoryService: class {
    searchMemories = vi.fn().mockResolvedValue([]);
    addMemory = vi.fn();
  },
}));

vi.mock('@/config/index.js', () => ({
  loadConfig: vi.fn().mockResolvedValue({}),
  getStyleForExtension: vi.fn().mockReturnValue('standard'),
}));

vi.mock('@/config/models.js', () => ({
  getLiveModel: vi.fn().mockReturnValue('gemini-2.0-flash-exp'),
}));

interface MockSessionService {
  getSession: Mock;
  getLatestSession: Mock;
  appendEvents: Mock;
}

describe('ServerLiveSession', () => {
  let liveSession: ServerLiveSession;
  let mockSessionService: MockSessionService;

  beforeEach(() => {
    vi.clearAllMocks();

    // Create actual mock instances with Partial types
    const mockClient = {
      live: {
        connect: mockLiveConnect,
      },
    } as unknown as GoogleGenAI;

    const mockService = new FirestoreSessionService() as unknown as FirestoreSessionService;
    const mockMemory = new MemoryService() as unknown as MemoryService;

    // Inject them into the constructor
    liveSession = new ServerLiveSession(mockClient, mockService, mockMemory);

    // Access the actual mock instances from the session object using unknown cast for safety
    const internalSession = liveSession as unknown as { sessionService: MockSessionService };
    mockSessionService = internalSession.sessionService;
  });

  it('sessionId ãŒæŒ‡å®šã•ã‚ŒãŸå ´åˆã€ãã‚Œã‚’ä½¿ç”¨ã—ã¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã˜ã‚ƒã‚“ã­ï¼âœ¨', async () => {
    const userId = 'user-123';
    const sessionId = 'session-456';

    await liveSession.start(userId, undefined, sessionId);

    // å†…éƒ¨ã® currentSessionId ãŒæ­£ã—ãã‚»ãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆprivate ã ã‘ã©ã‚¢ã‚¯ã‚»ã‚¹ã—ã¡ã‚ƒã†ã˜ã‚ƒã‚“ã­ï¼ğŸ¤«ï¼‰
    const internalSession = liveSession as unknown as { currentSessionId: string };
    expect(internalSession.currentSessionId).toBe(sessionId);

    // loadMemory å†…ã§ã¯ getLatestSession ãŒå‘¼ã°ã‚Œã‚‹ (å°†æ¥çš„ã« getSession ã«æœ€é©åŒ–ã•ã‚Œã‚‹ã‹ã‚‚ã ã‘ã©ã€ä»Šã¯ã“ã‚Œ)
    expect(mockSessionService.getLatestSession).toHaveBeenCalledWith(
      expect.objectContaining({
        userId,
      }),
    );
  });

  it('sessionId ãŒæŒ‡å®šã•ã‚Œãªã„å ´åˆã€æ–°ã—ã„ã‚»ãƒƒã‚·ãƒ§ãƒ³IDãŒç”Ÿæˆã•ã‚Œã‚‹ã˜ã‚ƒã‚“ã­ï¼ğŸ’', async () => {
    const userId = 'user-123';

    await liveSession.start(userId);

    // getLatestSession ãŒå‘¼ã°ã‚Œã‚‹
    expect(mockSessionService.getLatestSession).toHaveBeenCalled();

    // sessionId ã¯æ–°ã—ãç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã¯ãš
    const internalSession = liveSession as unknown as { currentSessionId: string };
    expect(internalSession.currentSessionId).toMatch(/^session-\d+$/);
  });
});
